<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµì› í˜„í™©í‘œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/table-styles.css">
  <style>
    /* ì—´ ë„ˆë¹„ ì„¤ì • - ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ìœ ì§€ */
    col:nth-child(1) { width: 30px !important; }
    col:nth-child(2) { width: 85px !important; }
    col:nth-child(3), col:nth-child(4), col:nth-child(5),
    col:nth-child(6), col:nth-child(7) { width: 160px !important; }
    col:nth-child(8) { width: 30px !important; }
    col:nth-child(9), col:nth-child(10), col:nth-child(11),
    col:nth-child(12), col:nth-child(13), col:nth-child(14) { width: 160px !important; }
    col:nth-child(15) { width: 30px !important; }
    col:nth-child(16), col:nth-child(17), col:nth-child(18),
    col:nth-child(19), col:nth-child(20), col:nth-child(21),
    col:nth-child(22) { width: 160px !important; }
    col:nth-child(23) { width: 40px !important; }

    /* ì²« ë²ˆì§¸ì™€ ë‘ ë²ˆì§¸ ì—´ ë„ˆë¹„ ê³ ì • */
    table tbody tr td:first-child,
    table thead tr th:first-child {
      width: 30px !important;
      min-width: 30px !important;
      max-width: 30px !important;
    }

    table tbody tr td:nth-child(2),
    table thead tr th:nth-child(2) {
      width: 85px !important;
      min-width: 85px !important;
      max-width: 85px !important;
    }

    /* colspan="2"ì¸ ê²½ìš° */
    table tbody tr td[colspan="2"],
    table thead tr th[colspan="2"] {
      width: 115px !important;
      min-width: 115px !important;
      max-width: 115px !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="controls">
      <div class="controls-left">
        <a href="admin.html" class="btn" style="text-decoration: none; display: inline-block;">ğŸ” ê´€ë¦¬ì</a>
      </div>
      <div class="controls-right">
        <button class="btn" onclick="loadData()">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
      </div>
    </div>
    
    <div id="content">
      <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    
    <div class="footnote">
      <div class="footnote-header" onclick="toggleFootnote()">
        <span>ì£¼ì˜ì‚¬í•­</span>
        <span class="arrow">â–¶</span>
      </div>
      <div class="footnote-content" id="footnoteContent">
        â€¢ ì§„í•œ ê¸€ì”¨: ì—°ë´‰ì œ ì „ì„êµì›<br/>
        â€¢ í…ìŠ¤íŠ¸ ìƒ‰ìƒ - <span style="color: #0066cc; font-weight: bold;">íŒŒë€ìƒ‰: íœ´ì§</span>, 
          <span style="color: #009900; font-weight: bold;">ì´ˆë¡ìƒ‰: ì—°êµ¬ë…„</span><br/>
        â€¢ <span class="retirement-upcoming" style="padding: 2px 4px; border-radius: 2px;">ì—°ë‘ìƒ‰ ë°°ê²½</span>: 12ê°œì›” ì´ë‚´ ì •ë…„ ë„ë˜ ì˜ˆì •<br/>
        â€¢ ì„ìš© ì¢…ë£Œì¼ ë°°ê²½ìƒ‰: <span class="appointment-urgent" style="padding: 2px 4px; border-radius: 2px;">ê¸´ê¸‰(1-3ê°œì›”)</span> 
          <span class="appointment-warning" style="padding: 2px 4px; border-radius: 2px;">ì£¼ì˜(4-6ê°œì›”)</span>
          <span class="appointment-caution" style="padding: 2px 4px; border-radius: 2px;">ê´€ì‹¬(7-9ê°œì›”)</span>
          <span class="appointment-notice" style="padding: 2px 4px; border-radius: 2px;">ì–‘í˜¸(10-12ê°œì›”)</span><br/>
        â€¢ ì´ë¦„ ì˜† ìˆ«ì: ì¬ì„ìš©/ì •ë…„ê¹Œì§€ ë‚¨ì€ ê°œì›” ìˆ˜ (12ê°œì›” ì´í•˜ë§Œ í‘œì‹œ)<br/>
        â€¢ ê° êµì›ëª…ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>
  </div>
  
  <!-- ëª¨ë‹¬ -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <span class="modal-close" onclick="closeModal()">&times;</span>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script>
    let globalData = null;
    
    // ì£¼ì˜ì‚¬í•­ í† ê¸€ í•¨ìˆ˜
    function toggleFootnote() {
      const content = document.getElementById('footnoteContent');
      const arrow = document.querySelector('.arrow');
      
      if (content.classList.contains('show')) {
        content.classList.remove('show');
        arrow.classList.remove('rotated');
      } else {
        content.classList.add('show');
        arrow.classList.add('rotated');
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = function() {
      loadData();
    };

    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadData() {
      document.getElementById('content').innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      try {
        const response = await api.getFacultyData();
        if (response.success) {
          handleSuccess(response.data);
        } else {
          handleError(response.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        handleError('ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ' + error.message);
      }
    }
    
    // ì„±ê³µ ì²˜ë¦¬
    function handleSuccess(data) {
      console.log('Received data:', data);
      console.log('Data keys:', Object.keys(data));
      globalData = data;
      renderTable();
    }
    
    // ì—ëŸ¬ ì²˜ë¦¬
    function handleError(error) {
      document.getElementById('content').innerHTML = 
        '<div class="error">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error + '</div>';
    }
    
    // í•™ê³¼ëª… í¬ë§·íŒ… í•¨ìˆ˜
    function formatDeptName(deptName) {
      if (deptName === 'ë¬´ë„ìŠ¤í¬ì¸ ì‚°ì—…í•™ê³¼(ê³„ì•½í•™ê³¼)') {
        return 'ë¬´ë„ìŠ¤í¬ì¸ ì‚°ì—…í•™ê³¼<br/>(ê³„ì•½í•™ê³¼)';
      } else if (deptName === 'ë¯¸ìš©ê²½ì˜í•™ê³¼(ì•¼)') {
        return 'ë¯¸ìš©ê²½ì˜í•™ê³¼<br/>(ì•¼)';
      }
      return deptName;
    }
    
    // ì„ìš© ì¢…ë£Œì¼ê¹Œì§€ì˜ ê°œì›” ìˆ˜ ê³„ì‚°
    function getMonthsUntilEnd(endDate) {
      if (!endDate) return null;
      
      const today = new Date();
      const end = new Date(endDate);
      
      if (isNaN(end.getTime())) return null;
      
      const yearDiff = end.getFullYear() - today.getFullYear();
      const monthDiff = end.getMonth() - today.getMonth();
      const dayDiff = end.getDate() - today.getDate();
      
      let totalMonths = yearDiff * 12 + monthDiff;
      if (dayDiff < 0) totalMonths--;
      
      return Math.max(0, totalMonths);
    }
    
    // ì„ìš© ì¢…ë£Œì¼ ê¸°ë°˜ CSS í´ë˜ìŠ¤ ê²°ì •
    function getAppointmentClass(item) {
      // ëª…ì˜ˆêµìˆ˜ëŠ” ê¸°ë³¸ ìŠ¤íƒ€ì¼
      if (item.position === 'ëª…ì˜ˆêµìˆ˜') {
        return 'appointment-safe';
      }
      
      // ì •ë…„ ë„ë˜ ì˜ˆì •ì ì²´í¬ (12ê°œì›” ì´ë‚´)
      if (item.isRetirementGuaranteed && item.retirementDate) {
        const monthsToRetirement = getMonthsUntilEnd(item.retirementDate);
        if (monthsToRetirement !== null && monthsToRetirement <= 12) {
          return 'retirement-upcoming';
        }
        // ì •ë…„ì´ ë³´ì¥ë˜ì—ˆì§€ë§Œ 12ê°œì›” ì´ìƒ ë‚¨ì€ ê²½ìš°ëŠ” ê¸°ë³¸ ìŠ¤íƒ€ì¼
        return 'appointment-safe';
      }
      
      // ì¼ë°˜ ì„ìš© ì¢…ë£Œì¼ ì²´í¬
      const endDate = item.reappointmentEnd || item.firstAppointmentEnd;
      const months = getMonthsUntilEnd(endDate);
      
      if (months === null || months > 12) return 'appointment-safe';
      if (months <= 3) return 'appointment-urgent';
      if (months <= 6) return 'appointment-warning';
      if (months <= 9) return 'appointment-caution';
      return 'appointment-notice';
    }
    
    // ì´ë¦„ ëª©ë¡ì„ ë²„íŠ¼ í˜•íƒœë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function formatNames(names) {
      if (!names || names.length === 0) return '';
      
      // ëª¨ë“  ì´ë¦„ì„ ê°œë³„ì ìœ¼ë¡œ ì¶”ì¶œ
      const allNames = [];
      
      names.forEach(item => {
        let nameStr = '';
        let classes = [];
        let originalItem = item;
        
        // ë¬¸ìì—´ì¸ ê²½ìš°
        if (typeof item === 'string') {
          // íŠ¹ìˆ˜ ì²˜ë¦¬: "í™ê¸¸ë™,ê¹€ì² ìˆ˜" ë˜ëŠ” "í™ê¸¸ë™ ê¹€ì² ìˆ˜" í˜•íƒœ ì²˜ë¦¬
          const cleanedStr = item.trim();
          
          // ì‰¼í‘œê°€ ìˆëŠ” ê²½ìš°
          if (cleanedStr.includes(',')) {
            cleanedStr.split(',').forEach(n => {
              const trimmed = n.trim();
              if (trimmed) allNames.push({name: trimmed, classes: [], item: {name: trimmed}});
            });
            return;
          }
          
          // ì‰¼í‘œê°€ ì—†ê³  ê³µë°±ì´ ìˆëŠ” ê²½ìš°
          // ì—°ì†ëœ í•œê¸€ ì´ë¦„ë“¤ì„ ì°¾ê¸° (2-4ê¸€ì)
          const namePattern = /[ê°€-í£]{2,4}/g;
          const foundNames = cleanedStr.match(namePattern);
          
          if (foundNames && foundNames.length > 1) {
            foundNames.forEach(n => allNames.push({name: n, classes: [], item: {name: n}}));
            return;
          }
          
          // ê·¸ ì™¸ì˜ ê²½ìš° ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ì´ë¦„ìœ¼ë¡œ ì²˜ë¦¬
          if (cleanedStr) {
            allNames.push({name: cleanedStr, classes: [], item: {name: cleanedStr}});
          }
        }
        // ê°ì²´ì¸ ê²½ìš°
        else {
          nameStr = item.name;
          
          // ê°ì²´ì˜ nameë„ ì—¬ëŸ¬ ì´ë¦„ì´ í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŒ
          if (nameStr.includes(',')) {
            nameStr.split(',').forEach(n => {
              const trimmed = n.trim();
              if (trimmed) {
                let formattedName = trimmed;
                const nameClasses = [];
                
                // ì¬ì§ ìƒíƒœëŠ” ë§ˆì§€ë§‰ ì´ë¦„ì—ë§Œ ì¶”ê°€
                if (item.status && nameStr.split(',').indexOf(n) === nameStr.split(',').length - 1) {
                  formattedName += `(${item.status})`;
                }
                
                // ìŠ¤íƒ€ì¼ ì ìš©
                if (item.isSalary) nameClasses.push('salary-bold');
                if (item.status === 'íœ´ì§') nameClasses.push('status-leave');
                else if (item.status === 'ì—°êµ¬') nameClasses.push('status-research');
                
                // ì„ìš© ì¢…ë£Œì¼ ê´€ë ¨ í´ë˜ìŠ¤ ì¶”ê°€
                nameClasses.push(getAppointmentClass(item));
                
                // ê°œì›” ìˆ˜ ê³„ì‚°
                let months = null;
                if (item.position !== 'ëª…ì˜ˆêµìˆ˜') {
                  if (item.isRetirementGuaranteed && item.retirementDate) {
                    months = getMonthsUntilEnd(item.retirementDate);
                  } else {
                    const endDate = item.reappointmentEnd || item.firstAppointmentEnd;
                    months = getMonthsUntilEnd(endDate);
                  }
                }
                
                allNames.push({name: formattedName, classes: nameClasses, item: {...item, serialType: item.serialType}, months: months});
              }
            });
            return;
          }
          
          // ì—°ë´‰ì œ í‘œì‹œ
          if (item.isSalary) {
            classes.push('salary-bold');
          }
          
          // ì¬ì§ ìƒíƒœ í‘œì‹œ
          if (item.status) {
            nameStr += `(${item.status})`;
            if (item.status === 'íœ´ì§') {
              classes.push('status-leave');
            } else if (item.status === 'ì—°êµ¬') {
              classes.push('status-research');
            }
          }
          
          // ì„ìš© ì¢…ë£Œì¼ ê´€ë ¨ í´ë˜ìŠ¤ ì¶”ê°€
          classes.push(getAppointmentClass(item));
          
          // ê°œì›” ìˆ˜ ê³„ì‚°
          let months = null;
          if (item.position !== 'ëª…ì˜ˆêµìˆ˜') {
            if (item.isRetirementGuaranteed && item.retirementDate) {
              const monthsToRetirement = getMonthsUntilEnd(item.retirementDate);
              if (monthsToRetirement !== null && monthsToRetirement <= 12) {
                months = monthsToRetirement;
              }
            } else {
              const endDate = item.reappointmentEnd || item.firstAppointmentEnd;
              months = getMonthsUntilEnd(endDate);
            }
          }
          
          allNames.push({name: nameStr, classes: classes, item: {...item, serialType: item.serialType}, months: months});
        }
      });
      
      // ë²„íŠ¼ í˜•íƒœë¡œ ìƒì„±
      const result = [];
      allNames.forEach((nameObj, i) => {
        const classStr = ['name-badge', ...nameObj.classes].join(' ');
        let appointmentInfo = '';
        
        // ì„ìš© ì¢…ë£Œì¼ ì •ë³´ í‘œì‹œ (ëª…ì˜ˆêµìˆ˜ ì œì™¸, 12ê°œì›” ì´í•˜ë§Œ)
        if (nameObj.months !== null && nameObj.months <= 12) {
          appointmentInfo = `<span class="appointment-info">${nameObj.months}ê°œì›”</span>`;
        }
        
        // ì¬ì§ ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©ì„ ìœ„í•œ ì¶”ê°€ ì²˜ë¦¬
        let nameText = nameObj.name;
        if (nameObj.item.status === 'íœ´ì§' && nameText.includes('(íœ´ì§)')) {
          nameText = `<span class="status-leave">${nameText}</span>`;
        } else if (nameObj.item.status === 'ì—°êµ¬' && nameText.includes('(ì—°êµ¬)')) {
          nameText = `<span class="status-research">${nameText}</span>`;
        }
        
        result.push(`<span class="${classStr}" onclick="showFacultyDetail('${encodeURIComponent(JSON.stringify(nameObj.item))}')">${nameText}${appointmentInfo}</span>`);
      });
      
      return result.join(' ');
    }
    
    // ë§Œë‚˜ì´ ê³„ì‚° í•¨ìˆ˜
    function calculateAge(birthDate) {
      if (!birthDate) return null;
      
      const today = new Date();
      const birth = new Date(birthDate);
      
      if (isNaN(birth.getTime())) return null;
      
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      
      return age;
    }
    
    // êµì› ìƒì„¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
    function showFacultyDetail(encodedData) {
      try {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const modal = document.getElementById('detailModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        
        // ì´ë¦„ì—ì„œ ìƒíƒœ ì •ë³´ ì œê±°
        let cleanName = data.name;
        if (data.status) {
          cleanName = cleanName.replace(`(${data.status})`, '').trim();
        }
        
        modalTitle.textContent = `${cleanName} êµì› ì •ë³´`;
        
        // ì„±ë³„ í‘œì‹œ
        let genderText = '';
        if (data.gender) {
          if (data.gender === 'ë‚¨') {
            genderText = '<span style="color: #0d6efd;">ë‚¨ì„±</span>';
          } else if (data.gender === 'ì—¬') {
            genderText = '<span style="color: #d63384;">ì—¬ì„±</span>';
          } else {
            genderText = data.gender;
          }
        } else {
          genderText = '<span style="color: #6c757d;">(ì •ë³´ ì—†ìŒ)</span>';
        }
        
        // ìƒë…„ì›”ì¼ í‘œì‹œ (ë§Œë‚˜ì´ í¬í•¨)
        let birthDateText = '';
        if (data.birthDate) {
          birthDateText = data.birthDate;
          const age = calculateAge(data.birthDate);
          if (age !== null) {
            birthDateText += ` (ë§Œ ${age}ì„¸)`;
          }
        } else {
          birthDateText = '<span style="color: #666;">(ì •ë³´ ì—†ìŒ)</span>';
        }
        
        // ì „ì„êµì›/ë¹„ì „ì„êµì› êµ¬ë¶„
        const fullTimePositions = ['êµìˆ˜', 'ë¶€êµìˆ˜', 'ì¡°êµìˆ˜', 'ë¶€êµìˆ˜(ë¹„ì •ë…„íŠ¸ë™)', 'ì¡°êµìˆ˜(ë¹„ì •ë…„íŠ¸ë™)'];
        const isFullTime = fullTimePositions.includes(data.position);
        
        // ìµœì´ˆ ì„ìš©ì¼ í…ìŠ¤íŠ¸
        let appointmentStartText = '';
        if (data.firstAppointmentStart) {
          if (isFullTime || data.serialType === 'ì „ì„êµì›') {
            appointmentStartText = `<li><strong>ì „ì„êµì› ìµœì´ˆ ì„ìš©ì¼:</strong> ${data.firstAppointmentStart}</li>`;
          } else {
            appointmentStartText = `<li><strong>ìµœì´ˆ ì„ìš© ì‹œì‘ì¼:</strong> ${data.firstAppointmentStart}</li>`;
          }
        }
        
        // ì„ìš© ì¢…ë£Œì¼ í‘œì‹œ
        let appointmentEndText = '';
        
        if (data.position === 'ëª…ì˜ˆêµìˆ˜') {
          // ëª…ì˜ˆêµìˆ˜ëŠ” ì„ìš© ì¢…ë£Œì¼ í‘œì‹œ ì•ˆí•¨
          appointmentEndText = '<span style="color: #6c757d;">(í•´ë‹¹ ì—†ìŒ)</span>';
        } else if (data.isRetirementGuaranteed && data.retirementDate) {
          // ì •ë…„ ë³´ì¥ëœ ê²½ìš° ì •ë…„ì¼ì í‘œì‹œ
          appointmentEndText = data.retirementDate;
          const monthsToRetirement = getMonthsUntilEnd(data.retirementDate);
          
          if (monthsToRetirement !== null) {
            if (monthsToRetirement <= 0) {
              appointmentEndText += ` <span style="color: #dc3545; font-weight: bold;">(ì •ë…„ ë„ë˜)</span>`;
            } else if (monthsToRetirement <= 12) {
              appointmentEndText += ` <span style="color: #28a745; font-weight: bold;">(ì •ë…„ê¹Œì§€ ${monthsToRetirement}ê°œì›”)</span>`;
            } else {
              appointmentEndText += ` <span style="color: #28a745;">(ì •ë…„ ë³´ì¥)</span>`;
            }
          }
        } else {
          // ì¼ë°˜ ì„ìš© ì¢…ë£Œì¼ í‘œì‹œ
          const endDate = data.reappointmentEnd || data.firstAppointmentEnd;
          
          if (endDate) {
            appointmentEndText = endDate;
            const months = getMonthsUntilEnd(endDate);
            
            if (months !== null) {
              if (months <= 0) {
                appointmentEndText += ` <span style="color: #dc3545; font-weight: bold;">(ë§Œë£Œë¨)</span>`;
              } else if (months <= 3) {
                appointmentEndText += ` <span style="color: #dc3545; font-weight: bold;">(${months}ê°œì›” ë‚¨ìŒ - ê¸´ê¸‰)</span>`;
              } else if (months <= 6) {
                appointmentEndText += ` <span style="color: #fd7e14; font-weight: bold;">(${months}ê°œì›” ë‚¨ìŒ - ì£¼ì˜)</span>`;
              } else if (months <= 12) {
                appointmentEndText += ` <span style="color: #ffc107; font-weight: bold;">(${months}ê°œì›” ë‚¨ìŒ)</span>`;
              } else {
                appointmentEndText += ` <span style="color: #28a745;">(${months}ê°œì›” ë‚¨ìŒ)</span>`;
              }
            }
          } else {
            appointmentEndText = '<span style="color: #6c757d;">(ì •ë³´ ì—†ìŒ)</span>';
          }
        }
        
        // ì¬ì§ ìƒíƒœ í…ìŠ¤íŠ¸
        let statusText = '';
        if (data.status) {
          const statusMap = {
            'íœ´ì§': 'íœ´ì§ ì¤‘',
            'ì—°êµ¬': 'ì—°êµ¬ë…„'
          };
          statusText = `<li><strong>ì¬ì§ ìƒíƒœ:</strong> ${statusMap[data.status] || data.status}</li>`;
        }
        
        // ê¸‰ì—¬ì²´ê³„ í…ìŠ¤íŠ¸
        let salaryText = '';
        if (data.serialType === 'ì „ì„êµì›') {
          if (data.isSalary) {
            salaryText = '<li><strong>ê¸‰ì—¬ì²´ê³„:</strong> <span style="color: #0d6efd; font-weight: bold;">ì—°ë´‰ì œ</span></li>';
          } else {
            salaryText = '<li><strong>ê¸‰ì—¬ì²´ê³„:</strong> í˜¸ë´‰ì œ</li>';
          }
        }
        
        // ì†Œì† ì •ë³´
        let deptText = '';
        if (data.college || data.dept) {
          deptText = `<li><strong>ì†Œì†:</strong> ${data.college || ''} ${data.dept || ''}</li>`;
        }
        
        // ì§ê¸‰ ì •ë³´
        let positionText = '';
        if (data.position) {
          positionText = `<li><strong>ì§ê¸‰:</strong> ${data.position}</li>`;
        }
        
        // ì§ë ¬ ì •ë³´ (ê¸°íƒ€ ì§ë ¬ì¸ ê²½ìš°ë§Œ)
        let serialTypeText = '';
        if (data.serialType && !['ì „ì„êµì›', 'ë¹„ì „ì„êµì›', 'ê°ì›êµìˆ˜', 'ê²¸ì„êµì›', 'ì´ˆë¹™êµì›', 'ê°•ì‚¬', 'íŠ¹ì„êµìˆ˜', 'ëª…ì˜ˆêµìˆ˜'].includes(data.serialType)) {
          serialTypeText = `<li><strong>ì§ë ¬:</strong> ${data.serialType}</li>`;
        }
        
        // ì„ìš© ì¢…ë£Œì¼ êµ¬ë¶„ í‘œì‹œ
        let appointmentTypeText = '';
        if (data.position !== 'ëª…ì˜ˆêµìˆ˜' && !data.isRetirementGuaranteed) {
          if (data.reappointmentEnd) {
            appointmentTypeText = '<li><strong>ì„ìš© ì¢…ë¥˜:</strong> ì¬ì„ìš©</li>';
          } else if (data.firstAppointmentEnd) {
            appointmentTypeText = '<li><strong>ì„ìš© ì¢…ë¥˜:</strong> ìµœì´ˆì„ìš©</li>';
          }
        }
        
        // ì„ìš© ì¢…ë£Œì¼ ë¼ë²¨ ê²°ì •
        let appointmentLabel = 'ì„ìš© ì¢…ë£Œì¼:';
        if (data.position === 'ëª…ì˜ˆêµìˆ˜') {
          appointmentLabel = 'ëª…ì˜ˆêµìˆ˜:';
        } else if (data.isRetirementGuaranteed && data.retirementDate) {
          appointmentLabel = 'ì •ë…„ì¼ì:';
        }
        
        modalBody.innerHTML = `
          <ul class="modal-list">
            <li><strong>ì„±ëª…:</strong> ${cleanName}</li>
            <li><strong>ì„±ë³„:</strong> ${genderText}</li>
            <li><strong>ìƒë…„ì›”ì¼:</strong> ${birthDateText}</li>
            ${appointmentStartText}
            <li><strong>${appointmentLabel}</strong> ${appointmentEndText}</li>
            ${appointmentTypeText}
            ${deptText}
            ${positionText}
            ${serialTypeText}
            ${statusText}
            ${salaryText}
          </ul>
        `;
        
        modal.style.display = 'block';
      } catch (error) {
        console.error('Error showing faculty detail:', error);
      }
    }
    
    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function closeModal() {
      document.getElementById('detailModal').style.display = 'none';
    }
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      const modal = document.getElementById('detailModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
    
    // í…Œì´ë¸” ë Œë”ë§
    function renderTable() {
      try {
        if (!globalData) {
          handleError('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        console.log('Rendering table with globalData:', globalData);
        const currentDate = new Date().toLocaleDateString('ko-KR');
        const { facultyData, deptStructure, fullTimePositions, partTimePositions, otherPositions } = globalData;

        if (!facultyData || !deptStructure) {
          console.error('Missing required data fields:', { facultyData, deptStructure });
          handleError('ë°ì´í„° êµ¬ì¡°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
      
      let html = `
        <div class="table-container">
          <table>
            <colgroup>
              <col style="width: 30px !important;">
              <col style="width: 85px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 30px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 30px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 160px !important;">
              <col style="width: 40px !important;">
            </colgroup>
            <thead>
              <tr>
                <th colspan="${3 + fullTimePositions.length + partTimePositions.length + otherPositions.length + 3}">
                  êµì›í˜„í™©(${currentDate})
                </th>
              </tr>
              <tr>
                <th rowspan="2" colspan="2">êµ¬ë¶„</th>
                <th colspan="${fullTimePositions.length + 1}">ì „ì„êµì›</th>
                <th colspan="${partTimePositions.length + 1}">ë¹„ì „ì„êµì›</th>
                <th colspan="${otherPositions.length}">ê¸°íƒ€</th>
                <th rowspan="2">í•©ê³„</th>
              </tr>
              <tr>
      `;
      
      // ì „ì„êµì› í—¤ë”
      fullTimePositions.forEach(pos => {
        if (pos.includes('ë¹„ì •ë…„íŠ¸ë™')) {
          const parts = pos.split('(');
          html += `<th>${parts[0]}<br/><span style="font-size: 10px;">(${parts[1]}</span></th>`;
        } else {
          html += `<th>${pos}</th>`;
        }
      });
      html += '<th class="subtotal-full">ì†Œê³„</th>';

      // ë¹„ì „ì„êµì› í—¤ë”
      partTimePositions.forEach(pos => {
        html += `<th>${pos}</th>`;
      });
      html += '<th class="subtotal-part">ì†Œê³„</th>';

      // ê¸°íƒ€ ì§ê¸‰ í—¤ë”
      otherPositions.forEach(pos => {
        html += `<th>${pos}</th>`;
      });
      
      html += '</tr></thead><tbody>';
      
      // ë°ì´í„° í–‰
      deptStructure.forEach(dept => {
        if (dept.name === 'ëŒ€í•™ì›' || (dept.subDepts && dept.subDepts.length > 0)) {
          // ëŒ€í•™ì›ì´ê±°ë‚˜ í•™ê³¼ê°€ ìˆëŠ” ëŒ€í•™
          
          // ì‹¤ì œ ë°ì´í„°ê°€ ìˆëŠ” í•™ê³¼ë§Œ í•„í„°ë§
          let activeDepts = dept.subDepts;
          if (dept.name !== 'ëŒ€í•™ì›') {
            activeDepts = dept.subDepts.filter(subDept => {
              const deptData = facultyData[dept.name] && facultyData[dept.name][subDept];
              if (!deptData) return false;
              // ìµœì†Œ í•œ ëª…ì´ë¼ë„ ìˆëŠ”ì§€ í™•ì¸
              return Object.values(deptData).some(arr => arr && arr.length > 0);
            });
          }
          
          if (activeDepts.length === 0 && dept.name === 'ëŒ€í•™ì›') {
            activeDepts = dept.subDepts; // ëŒ€í•™ì›ì€ í•­ìƒ í‘œì‹œ
          } else if (activeDepts.length === 0) {
            // í•™ê³¼ê°€ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
            return;
          }
          
          activeDepts.forEach((subDept, subIdx) => {
            const deptData = facultyData[dept.name] && facultyData[dept.name][subDept] ? 
                            facultyData[dept.name][subDept] : {};
            const fullTimeTotal = calculateTotal(deptData, fullTimePositions);
            const partTimeTotal = calculateTotal(deptData, partTimePositions);
            const otherTotal = calculateTotal(deptData, otherPositions);
            const grandTotal = fullTimeTotal + partTimeTotal + otherTotal;
            
            html += '<tr>';
            
            if (subIdx === 0) {
              // ì£¼ìš” ëŒ€í•™ë“¤ì€ ì„¸ë¡œë¡œ í‘œì‹œ
              const verticalDepts = ['ëŒ€í•™ì›', 'ë¬´ë„ëŒ€í•™', 'ì²´ìœ¡ê³¼í•™ëŒ€í•™', 'ë¬¸í™”ì˜ˆìˆ ëŒ€í•™', 'ì¸ë¬¸ì‚¬íšŒìœµí•©ëŒ€í•™', 'AIë°”ì´ì˜¤ìœµí•©ëŒ€í•™'];
              if (verticalDepts.includes(dept.name)) {
                html += `<td rowspan="${activeDepts.length}" class="dept-header dept-vertical">${dept.name}</td>`;
              } else {
                html += `<td rowspan="${activeDepts.length}" class="dept-header">${dept.name}</td>`;
              }
            }
            
            html += `<td class="dept-name">${formatDeptName(subDept)}</td>`;
            
            fullTimePositions.forEach(pos => {
              const names = deptData[pos] || [];
              html += `<td class="names-cell position-cell">${formatNames(names)}</td>`;
            });

            html += `<td class="subtotal-full">${fullTimeTotal}</td>`;

            partTimePositions.forEach(pos => {
              const names = deptData[pos] || [];
              html += `<td class="names-cell position-cell">${formatNames(names)}</td>`;
            });

            html += `<td class="subtotal-part">${partTimeTotal}</td>`;

            // ê¸°íƒ€ ì§ê¸‰ë“¤
            otherPositions.forEach(pos => {
              const names = deptData[pos] || [];
              html += `<td class="names-cell position-cell">${formatNames(names)}</td>`;
            });

            html += `<td class="grand-total">${grandTotal}</td>`;
            html += '</tr>';
          });
        } else {
          // í•™ê³¼ê°€ ì—†ëŠ” ëŒ€í•™/ë¶€ì„œ (ìš©ì˜¤ë¦„ëŒ€í•™, ì‚°í•™í˜‘ë ¥ë‹¨, í‰ê°€ì„±ê³¼ë¶„ì„ì„¼í„°, êµìœ¡í˜ì‹ ì›, íŠ¹ìˆ˜ì²´ìœ¡ì—°êµ¬ì†Œ ë“±)
          const deptData = facultyData[dept.name] || {};
          const fullTimeTotal = calculateTotal(deptData, fullTimePositions);
          const partTimeTotal = calculateTotal(deptData, partTimePositions);
          const otherTotal = calculateTotal(deptData, otherPositions);
          const grandTotal = fullTimeTotal + partTimeTotal + otherTotal;
          
          html += '<tr>';
          html += `<td colspan="2" class="dept-header">${dept.name}</td>`;
          
          fullTimePositions.forEach(pos => {
            const names = deptData[pos] || [];
            html += `<td class="names-cell position-cell">${formatNames(names)}</td>`;
          });

          html += `<td class="subtotal-full">${fullTimeTotal}</td>`;

          partTimePositions.forEach(pos => {
            const names = deptData[pos] || [];
            html += `<td class="names-cell position-cell">${formatNames(names)}</td>`;
          });

          html += `<td class="subtotal-part">${partTimeTotal}</td>`;

          // ê¸°íƒ€ ì§ê¸‰ë“¤
          otherPositions.forEach(pos => {
            const names = deptData[pos] || [];
            html += `<td class="names-cell position-cell">${formatNames(names)}</td>`;
          });

          html += `<td class="grand-total">${grandTotal}</td>`;
          html += '</tr>';
        }
      });
      
      // ê¸°íƒ€ í–‰ ì¶”ê°€
      const etcData = facultyData['ê¸°íƒ€'] || {};
      const etcFullTimeTotal = calculateTotal(etcData, fullTimePositions);
      const etcPartTimeTotal = calculateTotal(etcData, partTimePositions);
      const etcOtherTotal = calculateTotal(etcData, otherPositions);
      const etcGrandTotal = etcFullTimeTotal + etcPartTimeTotal + etcOtherTotal;
      
      html += '<tr>';
      html += '<td colspan="2" class="dept-header">ê¸°íƒ€</td>';
      
      fullTimePositions.forEach(pos => {
        const names = etcData[pos] || [];
        html += `<td class="names-cell position-cell">${formatNames(names)}</td>`;
      });

      html += `<td class="subtotal-full">${etcFullTimeTotal}</td>`;

      partTimePositions.forEach(pos => {
        const names = etcData[pos] || [];
        html += `<td class="names-cell position-cell">${formatNames(names)}</td>`;
      });

      html += `<td class="subtotal-part">${etcPartTimeTotal}</td>`;

      // ê¸°íƒ€ ì§ê¸‰ë“¤
      otherPositions.forEach(pos => {
        const names = etcData[pos] || [];
        html += `<td class="names-cell position-cell">${formatNames(names)}</td>`;
      });

      html += `<td class="grand-total">${etcGrandTotal}</td>`;
      html += '</tr>';
      
      // í•©ê³„ í–‰
      html += '<tr class="total-row">';
      html += '<td colspan="2">í•©ê³„</td>';

      let totalFullTime = 0;
      let totalPartTime = 0;
      let totalOther = 0;

      fullTimePositions.forEach(pos => {
        const total = calculateColumnTotal(pos);
        totalFullTime += total;
        html += `<td>${total}</td>`;
      });

      html += `<td class="subtotal-full">${totalFullTime}</td>`;

      partTimePositions.forEach(pos => {
        const total = calculateColumnTotal(pos);
        totalPartTime += total;
        html += `<td>${total}</td>`;
      });

      html += `<td class="subtotal-part">${totalPartTime}</td>`;

      // ê¸°íƒ€ ì§ê¸‰ í•©ê³„
      otherPositions.forEach(pos => {
        const total = calculateColumnTotal(pos);
        totalOther += total;
        html += `<td>${total}</td>`;
      });

      html += `<td class="grand-total">${totalFullTime + totalPartTime + totalOther}</td>`;
      html += '</tr>';
      
      html += '</tbody></table></div>';

      document.getElementById('content').innerHTML = html;
      } catch (error) {
        console.error('Render table error:', error);
        handleError('í…Œì´ë¸” ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // í•©ê³„ ê³„ì‚°
    function calculateTotal(data, positions) {
      if (!data) return 0;
      
      let total = 0;
      positions.forEach(pos => {
        if (data[pos] && Array.isArray(data[pos])) {
          total += data[pos].length;
        }
      });
      return total;
    }
    
    // ì—´ í•©ê³„ ê³„ì‚°
    function calculateColumnTotal(position) {
      const { facultyData, deptStructure } = globalData;
      let total = 0;
      
      deptStructure.forEach(dept => {
        if (dept.name === 'ëŒ€í•™ì›' || (dept.subDepts && dept.subDepts.length > 0)) {
          // ëŒ€í•™ì›ì´ê±°ë‚˜ í•™ê³¼ê°€ ìˆëŠ” ëŒ€í•™
          dept.subDepts.forEach(subDept => {
            if (facultyData[dept.name] && facultyData[dept.name][subDept] && facultyData[dept.name][subDept][position]) {
              total += facultyData[dept.name][subDept][position].length;
            }
          });
        } else {
          // í•™ê³¼ê°€ ì—†ëŠ” ë¶€ì„œ (ìš©ì˜¤ë¦„ëŒ€í•™, ì‚°í•™í˜‘ë ¥ë‹¨, í‰ê°€ì„±ê³¼ë¶„ì„ì„¼í„°, êµìœ¡í˜ì‹ ì›, íŠ¹ìˆ˜ì²´ìœ¡ì—°êµ¬ì†Œ ë“±)
          if (facultyData[dept.name] && facultyData[dept.name][position]) {
            total += facultyData[dept.name][position].length;
          }
        }
      });
      
      // ê¸°íƒ€ í–‰ë„ í¬í•¨
      if (facultyData['ê¸°íƒ€'] && facultyData['ê¸°íƒ€'][position]) {
        total += facultyData['ê¸°íƒ€'][position].length;
      }
      
      return total;
    }
  </script>
</body>
</html>
