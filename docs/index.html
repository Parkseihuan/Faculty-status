<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµì› í˜„í™©í‘œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/table-styles.css">
  <style>
    /* Notion ìŠ¤íƒ€ì¼ íƒ­ */
    .faculty-tabs {
      display: flex;
      gap: 4px;
      padding: 16px 24px 0 24px;
      border-bottom: 1px solid rgba(55, 53, 47, 0.09);
      background-color: white;
    }

    .faculty-tab {
      padding: 8px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: rgba(55, 53, 47, 0.65);
      border-bottom: 2px solid transparent;
      transition: all 0.15s ease;
      font-family: 'Inter', 'Noto Sans KR', sans-serif;
      margin-bottom: -1px;
      border-radius: 4px 4px 0 0;
    }

    .faculty-tab:hover {
      color: #37352f;
      background-color: rgba(55, 53, 47, 0.04);
    }

    .faculty-tab.active {
      color: #37352f;
      border-bottom-color: #37352f;
      background-color: transparent;
    }

    /* ìŠ¤í”¼ë„ˆ */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(55, 53, 47, 0.09);
      border-top: 4px solid #37352f;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="controls">
      <div class="controls-left">
        <a href="admin.html" class="btn">ğŸ” ê´€ë¦¬ì</a>
      </div>
      <div class="controls-right">
        <button class="btn" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
      </div>
    </div>

    <!-- êµì› êµ¬ë¶„ íƒ­ -->
    <div class="faculty-tabs">
      <button class="faculty-tab active" onclick="switchTab('fullTime')" id="tab-fullTime">
        ì „ì„êµì›
      </button>
      <button class="faculty-tab" onclick="switchTab('partTime')" id="tab-partTime">
        ë¹„ì „ì„êµì›
      </button>
      <button class="faculty-tab" onclick="switchTab('other')" id="tab-other">
        ê¸°íƒ€
      </button>
    </div>

    <div id="content" class="table-container">
      <div class="loading">
        <div>
          <div class="spinner"></div>
          <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
    </div>

    <div class="footnote">
      <div class="footnote-header" onclick="toggleFootnote()">
        <span>â„¹ï¸ ë²”ë¡€ ë° ì£¼ì˜ì‚¬í•­</span>
        <span class="arrow">â–¼</span>
      </div>
      <div class="footnote-content" id="footnoteContent">
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
          <div>
            <strong>í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼</strong><br/>
            â€¢ <b>ì§„í•œ ê¸€ì”¨</b>: ì—°ë´‰ì œ ì „ì„êµì›<br/>
            â€¢ <span style="color: #0b6e99; font-weight: bold;">íŒŒë€ìƒ‰</span>: íœ´ì§<br/>
            â€¢ <span style="color: #448361; font-weight: bold;">ì´ˆë¡ìƒ‰</span>: ì—°êµ¬ë…„
          </div>
          <div>
            <strong>ë°°ê²½ìƒ‰ ì˜ë¯¸ (ì„ìš©/ì •ë…„)</strong><br/>
            â€¢ <span class="name-badge retirement-upcoming">ì—°ë‘ìƒ‰</span>: 12ê°œì›” ì´ë‚´ ì •ë…„ ë„ë˜<br/>
            â€¢ <span class="name-badge appointment-urgent">ë¶‰ì€ìƒ‰</span>: ë§Œë£Œ 3ê°œì›” ì „ (ê¸´ê¸‰)<br/>
            â€¢ <span class="name-badge appointment-warning">ì£¼í™©ìƒ‰</span>: ë§Œë£Œ 6ê°œì›” ì „ (ì£¼ì˜)<br/>
            â€¢ <span class="name-badge appointment-caution">ë…¸ë€ìƒ‰</span>: ë§Œë£Œ 9ê°œì›” ì „ (ê´€ì‹¬)
          </div>
        </div>
        <div style="margin-top: 10px; font-size: 11px; color: rgba(55, 53, 47, 0.65);">
          * ì´ë¦„ ì˜† ìˆ«ì: ì¬ì„ìš©/ì •ë…„ê¹Œì§€ ë‚¨ì€ ê°œì›” ìˆ˜ (12ê°œì›” ì´í•˜ë§Œ í‘œì‹œ)<br/>
          * ê° êµì›ëª…ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">êµì› ì •ë³´</h3>
        <span class="modal-close" onclick="closeModal()">&times;</span>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script>
    let globalData = null;
    let currentTab = 'fullTime'; // ê¸°ë³¸ê°’: ì „ì„êµì›

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function switchTab(tabName) {
      currentTab = tabName;

      // íƒ­ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
      document.querySelectorAll('.faculty-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
      if (globalData) {
        renderTable();
      }
    }

    // ì£¼ì˜ì‚¬í•­ í† ê¸€ í•¨ìˆ˜
    function toggleFootnote() {
      const content = document.getElementById('footnoteContent');
      const arrow = document.querySelector('.arrow');

      if (content.style.display === 'block') {
        content.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
      } else {
        content.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = function() {
      loadData();
    };

    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadData() {
      document.getElementById('content').innerHTML = `
        <div class="loading">
          <div>
            <div class="spinner"></div>
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>
      `;

      try {
        const response = await api.getFacultyData();
        if (response.success) {
          handleSuccess(response.data);
        } else {
          handleError(response.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        handleError('ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ' + error.message);
      }
    }

    // ì„±ê³µ ì²˜ë¦¬
    function handleSuccess(data) {
      console.log('Received data:', data);
      globalData = data;
      renderTable();
    }

    // ì—ëŸ¬ ì²˜ë¦¬
    function handleError(error) {
      document.getElementById('content').innerHTML =
        '<div class="error">âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤<br>' + error + '</div>';
    }

    // í•™ê³¼ëª… í¬ë§·íŒ… í•¨ìˆ˜
    function formatDeptName(deptName) {
      // í•™ê³¼ëª…ì€ ì¤„ë°”ê¿ˆ ì—†ì´ í•œ ì¤„ë¡œ í‘œì‹œ
      return deptName;
    }

    // ì„ìš© ì¢…ë£Œì¼ê¹Œì§€ì˜ ê°œì›” ìˆ˜ ê³„ì‚°
    function getMonthsUntilEnd(endDate) {
      if (!endDate) return null;

      const today = new Date();
      const end = new Date(endDate);

      if (isNaN(end.getTime())) return null;

      const yearDiff = end.getFullYear() - today.getFullYear();
      const monthDiff = end.getMonth() - today.getMonth();
      const dayDiff = end.getDate() - today.getDate();

      let totalMonths = yearDiff * 12 + monthDiff;
      if (dayDiff < 0) totalMonths--;

      return Math.max(0, totalMonths);
    }

    // ì„ìš© ì¢…ë£Œì¼ ê¸°ë°˜ CSS í´ë˜ìŠ¤ ê²°ì •
    function getAppointmentClass(item) {
      if (item.position === 'ëª…ì˜ˆêµìˆ˜') {
        return 'appointment-safe';
      }

      if (item.isRetirementGuaranteed && item.retirementDate) {
        const monthsToRetirement = getMonthsUntilEnd(item.retirementDate);
        if (monthsToRetirement !== null && monthsToRetirement <= 12) {
          return 'retirement-upcoming';
        }
        return 'appointment-safe';
      }

      const endDate = item.reappointmentEnd || item.firstAppointmentEnd;
      const months = getMonthsUntilEnd(endDate);

      if (months === null || months > 12) return 'appointment-safe';
      if (months <= 3) return 'appointment-urgent';
      if (months <= 6) return 'appointment-warning';
      if (months <= 9) return 'appointment-caution';
      return 'appointment-notice';
    }

    // ì´ë¦„ ëª©ë¡ì„ ë²„íŠ¼ í˜•íƒœë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function formatNames(names) {
      if (!names || names.length === 0) return '';

      const allNames = [];

      names.forEach(item => {
        let nameStr = '';
        let classes = [];

        if (typeof item === 'string') {
          const cleanedStr = item.trim();
          if (cleanedStr.includes(',')) {
            cleanedStr.split(',').forEach(n => {
              const trimmed = n.trim();
              if (trimmed) allNames.push({name: trimmed, classes: [], item: {name: trimmed}});
            });
            return;
          }

          const namePattern = /[ê°€-í£]{2,4}/g;
          const foundNames = cleanedStr.match(namePattern);

          if (foundNames && foundNames.length > 1) {
            foundNames.forEach(n => allNames.push({name: n, classes: [], item: {name: n}}));
            return;
          }

          if (cleanedStr) {
            allNames.push({name: cleanedStr, classes: [], item: {name: cleanedStr}});
          }
        } else {
          nameStr = item.name;

          if (nameStr.includes(',')) {
            nameStr.split(',').forEach(n => {
              const trimmed = n.trim();
              if (trimmed) {
                let formattedName = trimmed;
                const nameClasses = [];

                if (item.status && nameStr.split(',').indexOf(n) === nameStr.split(',').length - 1) {
                  formattedName += `(${item.status})`;
                }

                if (item.isSalary) nameClasses.push('salary-bold');
                if (item.status === 'íœ´ì§') nameClasses.push('status-leave');
                else if (item.status === 'ì—°êµ¬') nameClasses.push('status-research');

                nameClasses.push(getAppointmentClass(item));

                let months = null;
                if (item.position !== 'ëª…ì˜ˆêµìˆ˜') {
                  if (item.isRetirementGuaranteed && item.retirementDate) {
                    months = getMonthsUntilEnd(item.retirementDate);
                  } else {
                    const endDate = item.reappointmentEnd || item.firstAppointmentEnd;
                    months = getMonthsUntilEnd(endDate);
                  }
                }

                allNames.push({name: formattedName, classes: nameClasses, item: {...item, serialType: item.serialType}, months: months});
              }
            });
            return;
          }

          if (item.isSalary) classes.push('salary-bold');

          if (item.status) {
            nameStr += `(${item.status})`;
            if (item.status === 'íœ´ì§') classes.push('status-leave');
            else if (item.status === 'ì—°êµ¬') classes.push('status-research');
          }

          classes.push(getAppointmentClass(item));

          let months = null;
          if (item.position !== 'ëª…ì˜ˆêµìˆ˜') {
            if (item.isRetirementGuaranteed && item.retirementDate) {
              const monthsToRetirement = getMonthsUntilEnd(item.retirementDate);
              if (monthsToRetirement !== null && monthsToRetirement <= 12) {
                months = monthsToRetirement;
              }
            } else {
              const endDate = item.reappointmentEnd || item.firstAppointmentEnd;
              months = getMonthsUntilEnd(endDate);
            }
          }

          allNames.push({name: nameStr, classes: classes, item: {...item, serialType: item.serialType}, months: months});
        }
      });

      const result = [];
      allNames.forEach((nameObj) => {
        const classStr = ['name-badge', ...nameObj.classes].join(' ');
        let appointmentInfo = '';

        if (nameObj.months !== null && nameObj.months <= 12) {
          appointmentInfo = `<span class="appointment-info">${nameObj.months}</span>`;
        }

        let nameText = nameObj.name;

        result.push(`<span class="${classStr}" onclick="showFacultyDetail('${encodeURIComponent(JSON.stringify(nameObj.item))}')">${nameText}${appointmentInfo}</span>`);
      });

      return result.join(' ');
    }

    // ë§Œë‚˜ì´ ê³„ì‚° í•¨ìˆ˜
    function calculateAge(birthDate) {
      if (!birthDate) return null;
      const today = new Date();
      const birth = new Date(birthDate);
      if (isNaN(birth.getTime())) return null;
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return age;
    }

    // êµì› ìƒì„¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
    function showFacultyDetail(encodedData) {
      try {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const modal = document.getElementById('detailModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        let cleanName = data.name;
        if (data.status) {
          cleanName = cleanName.replace(`(${data.status})`, '').trim();
        }

        modalTitle.textContent = `${cleanName} êµì› ì •ë³´`;

        let genderText = data.gender ? (data.gender === 'ë‚¨' ? '<span style="color: #0b6e99;">ë‚¨ì„±</span>' : '<span style="color: #d44c47;">ì—¬ì„±</span>') : '<span style="color: rgba(55, 53, 47, 0.45);">(ì •ë³´ ì—†ìŒ)</span>';

        let birthDateText = data.birthDate || '<span style="color: rgba(55, 53, 47, 0.45);">(ì •ë³´ ì—†ìŒ)</span>';
        const age = calculateAge(data.birthDate);
        if (age !== null) birthDateText += ` (ë§Œ ${age}ì„¸)`;

        let listHtml = `<ul class="modal-list">`;
        listHtml += `<li><strong>ì„±ëª…</strong> ${cleanName}</li>`;
        listHtml += `<li><strong>ì„±ë³„</strong> ${genderText}</li>`;
        listHtml += `<li><strong>ìƒë…„ì›”ì¼</strong> ${birthDateText}</li>`;

        if (data.firstAppointmentStart) {
            listHtml += `<li><strong>ìµœì´ˆ ì„ìš©ì¼</strong> ${data.firstAppointmentStart}</li>`;
        }

        let endLabel = 'ì„ìš© ì¢…ë£Œì¼';
        let endValue = '';
        if (data.position === 'ëª…ì˜ˆêµìˆ˜') {
            endValue = 'í•´ë‹¹ ì—†ìŒ';
        } else if (data.isRetirementGuaranteed && data.retirementDate) {
            endLabel = 'ì •ë…„ ì¼ì';
            endValue = data.retirementDate;
            const m = getMonthsUntilEnd(data.retirementDate);
            if (m !== null) endValue += ` (${m}ê°œì›” ë‚¨ìŒ)`;
        } else {
            const end = data.reappointmentEnd || data.firstAppointmentEnd;
            if (end) {
                endValue = end;
                const m = getMonthsUntilEnd(end);
                if (m !== null) endValue += ` (${m}ê°œì›” ë‚¨ìŒ)`;
            } else {
                endValue = '(ì •ë³´ ì—†ìŒ)';
            }
        }
        listHtml += `<li><strong>${endLabel}</strong> ${endValue}</li>`;

        if (data.college || data.dept) {
            listHtml += `<li><strong>ì†Œì†</strong> ${data.college || ''} ${data.dept || ''}</li>`;
        }

        if (data.position) {
            listHtml += `<li><strong>ì§ê¸‰</strong> ${data.position}</li>`;
        }

        if (data.status) {
            listHtml += `<li><strong>ìƒíƒœ</strong> ${data.status}</li>`;
        }

        if (data.serialType === 'ì „ì„êµì›') {
            listHtml += `<li><strong>ê¸‰ì—¬ì²´ê³„</strong> ${data.isSalary ? 'ì—°ë´‰ì œ' : 'í˜¸ë´‰ì œ'}</li>`;
        }

        listHtml += `</ul>`;

        modalBody.innerHTML = listHtml;
        modal.style.display = 'block';
      } catch (error) {
        console.error('Error showing faculty detail:', error);
      }
    }

    function closeModal() {
      document.getElementById('detailModal').style.display = 'none';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('detailModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // í…Œì´ë¸” ë Œë”ë§ (íƒ­ë³„ë¡œ ë‹¤ë¥¸ ì»¬ëŸ¼ í‘œì‹œ)
    function renderTable() {
      if (!globalData) return;

      const { facultyData, deptStructure, fullTimePositions, partTimePositions, otherPositions } = globalData;
      const currentDate = new Date().toLocaleDateString('ko-KR');

      // í˜„ì¬ íƒ­ì— ë”°ë¼ í‘œì‹œí•  ì»¬ëŸ¼ ê²°ì •
      let positions = [];
      let tabTitle = '';

      if (currentTab === 'fullTime') {
        positions = fullTimePositions;
        tabTitle = 'ì „ì„êµì›';
      } else if (currentTab === 'partTime') {
        positions = partTimePositions;
        tabTitle = 'ë¹„ì „ì„êµì›';
      } else {
        positions = otherPositions;
        tabTitle = 'ê¸°íƒ€';
      }

      let html = `
        <table>
            <thead>
              <tr>
                <th colspan="${3 + positions.length}">
                  ${tabTitle} í˜„í™© (${currentDate})
                </th>
              </tr>
              <tr>
                <th colspan="2">êµ¬ë¶„</th>
      `;

      positions.forEach(pos => {
        if (pos.includes('ë¹„ì •ë…„íŠ¸ë™')) {
          const parts = pos.split('(');
          html += `<th>${parts[0]}<br/><span style="font-size: 11px; color: rgba(55, 53, 47, 0.65);">(${parts[1]}</span></th>`;
        } else {
          html += `<th>${pos}</th>`;
        }
      });
      html += '<th class="subtotal-full">í•©ê³„</th>';
      html += '</tr></thead><tbody>';

      const calculateTotal = (data, positions) => {
        let total = 0;
        positions.forEach(pos => {
          if (data[pos]) total += data[pos].length;
        });
        return total;
      };

      const calculateColumnTotal = (pos) => {
        let total = 0;
        Object.entries(facultyData).forEach(([deptName, deptGroup]) => {
          // deptGroup[pos]ê°€ ë°°ì—´ì´ë©´ í‰ë©´ êµ¬ì¡° (í•˜ìœ„ í•™ê³¼ ì—†ìŒ)
          if (Array.isArray(deptGroup[pos])) {
            total += deptGroup[pos].length;
          } else {
            // í•˜ìœ„ í•™ê³¼ê°€ ìˆëŠ” êµ¬ì¡°
            Object.values(deptGroup).forEach(dept => {
              if (dept && dept[pos]) total += dept[pos].length;
            });
          }
        });
        return total;
      };

      deptStructure.forEach(dept => {
        if (dept.name === 'ëŒ€í•™ì›' || (dept.subDepts && dept.subDepts.length > 0)) {
           let activeDepts = dept.subDepts;
           if (dept.name !== 'ëŒ€í•™ì›') {
             activeDepts = dept.subDepts.filter(subDept => {
               const deptData = facultyData[dept.name] && facultyData[dept.name][subDept];
               return deptData && Object.values(deptData).some(arr => arr && arr.length > 0);
             });
           }
           if (activeDepts.length === 0 && dept.name === 'ëŒ€í•™ì›') activeDepts = dept.subDepts;
           else if (activeDepts.length === 0) return;

           activeDepts.forEach((subDept, subIdx) => {
             const deptData = facultyData[dept.name] && facultyData[dept.name][subDept] ? facultyData[dept.name][subDept] : {};
             const total = calculateTotal(deptData, positions);

             html += '<tr>';
             if (subIdx === 0) {
                const verticalDepts = ['ëŒ€í•™ì›', 'ë¬´ë„ëŒ€í•™', 'ì²´ìœ¡ê³¼í•™ëŒ€í•™', 'ë¬¸í™”ì˜ˆìˆ ëŒ€í•™', 'ì¸ë¬¸ì‚¬íšŒìœµí•©ëŒ€í•™', 'AIë°”ì´ì˜¤ìœµí•©ëŒ€í•™'];
                const isVertical = verticalDepts.includes(dept.name);
                html += `<td rowspan="${activeDepts.length}" class="dept-header ${isVertical ? 'dept-vertical' : ''}">${dept.name}</td>`;
             }
             html += `<td class="dept-name">${formatDeptName(subDept)}</td>`;

             positions.forEach(pos => html += `<td class="names-cell">${formatNames(deptData[pos])}</td>`);
             html += `<td class="subtotal-full">${total}</td>`;
             html += '</tr>';
           });
        } else {
           const deptData = facultyData[dept.name] || {};
           const total = calculateTotal(deptData, positions);

           html += '<tr>';
           html += `<td colspan="2" class="dept-header">${dept.name}</td>`;
           positions.forEach(pos => html += `<td class="names-cell">${formatNames(deptData[pos])}</td>`);
           html += `<td class="subtotal-full">${total}</td>`;
           html += '</tr>';
        }
      });

      const etcData = facultyData['ê¸°íƒ€'] || {};
      const etcTotal = calculateTotal(etcData, positions);

      html += '<tr><td colspan="2" class="dept-header">ê¸°íƒ€</td>';
      positions.forEach(pos => html += `<td class="names-cell">${formatNames(etcData[pos])}</td>`);
      html += `<td class="subtotal-full">${etcTotal}</td></tr>`;

      html += '<tr class="total-row"><td colspan="2">í•©ê³„</td>';

      let grandTotal = 0;
      positions.forEach(pos => {
        const total = calculateColumnTotal(pos);
        grandTotal += total;
        html += `<td>${total}</td>`;
      });
      html += `<td>${grandTotal}</td></tr>`;

      html += '</tbody></table>';

      document.getElementById('content').innerHTML = html;
    }
  </script>
</body>
</html>
