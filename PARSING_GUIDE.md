# 교원 데이터 파싱 가이드

이 문서는 Faculty-status 프로젝트의 엑셀 데이터 파싱 로직, 매핑 테이블, 특수 조건 등을 상세히 설명합니다.

## 목차
1. [파싱 프로세스 개요](#파싱-프로세스-개요)
2. [직급 매핑 테이블](#직급-매핑-테이블)
3. [교원 분류 규칙](#교원-분류-규칙)
4. [조직 구조 및 배치 로직](#조직-구조-및-배치-로직)
5. [필터링 규칙](#필터링-규칙)
6. [특수 케이스 처리](#특수-케이스-처리)
7. [상태 및 스타일링](#상태-및-스타일링)
8. [트러블슈팅](#트러블슈팅)

---

## 파싱 프로세스 개요

### 1. 파일 형식 감지
- **지원 형식**: `.xls` (구버전), `.xlsx` (신버전)
- **감지 방법**: 확장자 + 파일 시그니처
- **라이브러리**:
  - `.xlsx`: ExcelJS (더 안전)
  - `.xls`: xlsx 라이브러리

### 2. 헤더 행 찾기
엑셀 파일의 처음 20행을 스캔하여 "성명" 또는 "성명(한글)" 컬럼이 있는 행을 헤더로 인식합니다.

### 3. 컬럼 매핑
다음 컬럼들을 찾아 인덱스를 저장합니다:
- 대학
- 소속
- 직번
- 성명 / 성명(한글)
- 직렬
- 직급
- 성별
- 재직구분
- 호봉
- 최초임용 시작일 / 전임교원 최초임용일
- 최초임용 종료일
- 재임용종료일
- 생년월일
- 정년일자

### 4. 데이터 행 처리
헤더 다음 행부터 끝까지 각 행을 처리합니다:
1. 재직 상태 확인 (재직/연구년/휴직만 처리)
2. 필터링 규칙 적용
3. 직급 매핑
4. 조직 배치
5. 상태 정보 추가

---

## 직급 매핑 테이블

### 전임교원 직급 (fullTimePositions)
| 원본 직급 | 매핑 결과 |
|-----------|-----------|
| 교  수 | 교수 |
| 교수 | 교수 |
| 부교수 | 부교수 |
| 조교수 | 조교수 |
| 부교수(비정년트랙) | 부교수(비정년트랙) |
| 조교수(비정년트랙) | 조교수(비정년트랙) |

### 비전임교원 직급 (partTimePositions)
| 원본 직급 | 매핑 결과 |
|-----------|-----------|
| 특임교수 | 특임교수 |
| 객원교수 | 객원교수 |
| 겸임교원 | 겸임교원 |
| 겸임교원(비전임) | 겸임교원 |
| 겸임교수 | 겸임교원 |
| 겸임부교수 | 겸임교원 |
| 겸임조교수 | 겸임교원 |
| 겸임조교수. | 겸임교원 |
| 초빙교원 | 초빙교원 |
| 초빙교원(비전임) | 초빙교원 |
| 강사 | 강사 |
| 시간강사 | 강사 |
| 명예교수 | 명예교수 |

**⚠️ 주의**: 시간강사는 '강사'로 매핑되지만 파싱 과정에서 **제외**됩니다 (필터링 규칙 참조)

### 기타 직급 (otherPositions)
| 원본 직급 | 매핑 결과 |
|-----------|-----------|
| 특별연구원 | 특별연구원 |
| 학술연구교수 | 학술연구교수 |
| 전임연구원 | 전임연구원 |
| 전임연구원(혁신사업) | 전임연구원 |
| 학예연구사 | 학예연구사 |
| 전문상담원 | 전문상담원 |
| 전임지도자 | 전임지도자 |
| 기술감독 | 기술감독 |

---

## 교원 분류 규칙

파싱된 교원은 다음 세 가지 카테고리로 분류됩니다:

### 1. 전임교원
- 교수, 부교수, 조교수
- 부교수(비정년트랙), 조교수(비정년트랙)

### 2. 비전임교원
- 특임교수, 객원교수
- 겸임교원, 초빙교원
- 강사 (단, 시간강사는 제외)
- 명예교수

### 3. 기타
- 특별연구원, 학술연구교수
- 전임연구원, 학예연구사
- 전문상담원, 전임지도자, 기술감독

---

## 조직 구조 및 배치 로직

### 기본 조직 구조

#### 대학원 (하위 조직 있음)
- 교육대학원
- 일반대학원
- 재활복지대학원
- 태권도대학원
- 문화예술대학원
- 스포츠과학대학원

#### 일반 대학
- 무도대학
- 체육과학대학
- 경영대학
- 문화예술대학
- 융합과학대학

#### 특별 부서 (단독 처리)
다음 부서는 하위 학과 없이 단독으로 표시됩니다:
- 평가성과분석센터
- 산학협력단
- 용오름대학
- 교육혁신원
- 원격교육지원센터
- 박물관
- 체육지원실
- 교수학습지원센터
- 스포츠.웰니스연구센터
- 특수체육연구소
- 무도연구소
- 혁신사업추진단
- 학생생활상담센터
- 취창업지원센터
- 인권센터

### 배치 우선순위

교원을 조직에 배치할 때 다음 우선순위를 따릅니다:

#### 1순위: 특별 부서 (소속)
소속 필드가 특별 부서 목록에 있으면 해당 부서에 배치

```javascript
if (dept === '혁신사업추진단') {
  // 혁신사업추진단에 배치
}
```

#### 2순위: 특별 부서 (대학)
대학 필드가 특별 부서 목록에 있으면 해당 부서에 배치

#### 3순위: 대학원 처리
대학원 배치는 세 가지 패턴을 처리합니다:

**패턴 A**: college가 대학원 이름인 경우
```
college: "스포츠과학대학원"
dept: ""
→ 대학원 > 스포츠과학대학원
```

**패턴 B**: college가 "대학원"이고 dept가 구체적인 대학원 이름
```
college: "대학원"
dept: "일반대학원"
→ 대학원 > 일반대학원
```

**패턴 C**: dept에 대학원 이름이 포함된 경우 (⚠️ 중요!)
```
college: ""
dept: "일반대학원 보건복지학과"
→ 대학원 > 일반대학원
```

```
college: ""
dept: "스포츠과학대학원 체육과학과"
→ 대학원 > 스포츠과학대학원
```

**처리 로직**:
```javascript
for (const gradSchool of graduateSchools) {
  if (dept && dept.includes(gradSchool)) {
    // 대학원명이 dept에 포함되어 있으면 해당 대학원에 배치
  }
}
```

#### 4순위: 일반 대학의 학과
```
college: "무도대학"
dept: "태권도학과"
→ 무도대학 > 태권도학과
```

#### 5순위: 기타
위 모든 조건에 매칭되지 않으면 "기타"로 분류

---

## 필터링 규칙

### 1. 재직 상태 필터
다음 재직구분만 처리합니다:
- **재직**: 정상 근무 중
- **연구년**: 연구년 중 (특별 표시)
- **휴직**: 휴직 중 (특별 표시)

**제외되는 상태**:
- 퇴직
- 기간만료
- 기타

### 2. 시간강사 제외 (⚠️ 중요!)
**직렬이 '시간강사'인 교원은 완전히 제외됩니다.**

```javascript
if (rowData.serialType === '시간강사') {
  continue; // 처리하지 않음
}
```

**이유**: 시간강사는 본 부서 관리 대상이 아님

**영향받는 인원 예시**:
- 김병주, 조지현, 정재욱 (유도학과)
- 김갑수, 권관배, 한창효 (태권도학과)
- 신상엽 (경호학과)
- 등등...

---

## 특수 케이스 처리

### 1. 혁신사업 교원
**조건**: 직급에 "혁신사업" 문자열이 포함된 경우

**예시**:
- 전임연구원(혁신사업)

**처리**:
1. 백엔드: `전임연구원(혁신사업)` → `전임연구원`으로 매핑
2. 프론트엔드: `position.includes('혁신사업')` 체크
3. 스타일: 보라색 배경 + 보라색 텍스트 (`innovation-project` 클래스)

**CSS**:
```css
.innovation-project {
  background-color: rgba(140, 46, 184, 0.12) !important;
  color: #7c3aed !important;
  font-weight: 500;
}
```

### 2. 연봉제 교원
**조건**:
- 직렬이 '전임교원' **AND**
- 호봉 필드가 비어있음

**표시**: 이름에 진한 글씨 (`salary-bold` 클래스)

### 3. 휴직/연구년 교원
**휴직**:
- 재직구분에 "휴직" 포함
- 이름 뒤에 "(휴직)" 추가
- 파란색 텍스트

**연구년**:
- 재직구분에 "연구년" 포함
- 이름 뒤에 "(연구)" 추가
- 초록색 텍스트

### 4. 정년 보장 교원
**조건**:
- 재임용종료일 === 정년일자 **AND**
- 직급이 '명예교수'가 아님

**처리**: 임용 종료일 대신 정년일을 기준으로 개월 수 계산

### 5. 명예교수
**특별 처리**:
- 임용 종료일 계산 안 함
- 배경색 없음 (`appointment-safe` 클래스)

---

## 상태 및 스타일링

### 임용 종료일 기반 색상

프론트엔드에서 교원 이름에 임용 종료일까지의 개월 수를 계산하여 색상을 적용합니다.

| 남은 개월 | 배경색 | 클래스명 | 의미 |
|-----------|--------|----------|------|
| 3개월 이하 | 붉은색 | `appointment-urgent` | 긴급 |
| 4~6개월 | 주황색 | `appointment-warning` | 주의 |
| 7~9개월 | 노란색 | `appointment-caution` | 관심 |
| 10~12개월 | 투명 | `appointment-notice` | 알림 |
| 12개월 초과 | 투명 | `appointment-safe` | 안전 |

**정년 도래**:
| 남은 개월 | 배경색 | 클래스명 | 의미 |
|-----------|--------|----------|------|
| 12개월 이하 | 연두색 | `retirement-upcoming` | 정년 도래 |

### 개월 수 표시
- 12개월 이하인 경우만 이름 옆에 개월 수 표시
- 예: `홍길동(3M)` - 3개월 남음
- 예: `김철수(11M)` - 11개월 남음

### 스타일 우선순위
여러 조건이 겹칠 경우 다음 순서로 적용됩니다:

1. 혁신사업 (`innovation-project`)
2. 휴직/연구년 (`status-leave`, `status-research`)
3. 연봉제 (`salary-bold`)
4. 임용/정년 색상 (`appointment-*`, `retirement-upcoming`)

---

## 트러블슈팅

### 문제 1: 교원이 표에 나타나지 않음

**체크리스트**:

1. ✅ **재직구분 확인**
   - "재직", "연구년", "휴직" 중 하나인가?
   - 퇴직/기간만료는 표시되지 않음

2. ✅ **시간강사 여부 확인**
   - 직렬이 "시간강사"인가?
   - 시간강사는 의도적으로 제외됨

3. ✅ **직급 매핑 확인**
   - 직급이 매핑 테이블에 있는가?
   - 없다면 `otherPositionMapping`에 추가 필요

4. ✅ **소속 배치 확인**
   - 대학/소속 정보가 올바른가?
   - 대학원 소속의 경우 패턴 C 확인 (dept에 대학원명 포함)

**해결 방법**:
- 백엔드 로그 확인: `console.log('Data row X sample: ...')`
- 파싱된 데이터 확인: MongoDB에서 Faculty 데이터 조회
- 필요시 매핑 테이블 업데이트

### 문제 2: 교원이 "기타"로 분류됨

**원인**:
- 조직 배치 로직의 1~4순위에 모두 실패

**체크리스트**:

1. ✅ **대학원 소속 확인**
   - dept에 대학원 이름이 포함되어 있는가?
   - 예: "일반대학원 보건복지학과" (O)
   - 예: "보건복지학과" (X)

2. ✅ **특별 부서 확인**
   - 소속이 특별 부서 목록에 있는가?
   - 없다면 `specialDepts` 배열에 추가 필요

3. ✅ **대학/학과 이름 확인**
   - 조직 구조와 정확히 일치하는가?
   - 공백, 특수문자 주의

**해결 방법**:
```javascript
// backend/utils/excelParser.js
const specialDepts = [
  // ... 기존 부서들
  '새로운부서이름'  // 추가
];
```

### 문제 3: 새로운 직급이 생겼을 때

**증상**: 해당 직급의 교원이 표에 나타나지 않거나 "기타"로 분류됨

**해결 단계**:

1. **직급 분류 결정**
   - 전임교원? → `positionMapping` + `fullTimePositions`
   - 비전임교원? → `positionMapping` + `partTimePositions`
   - 기타? → `otherPositionMapping` + `otherPositions`

2. **매핑 추가** (`backend/utils/excelParser.js`)
```javascript
// 예: 신임교수라는 새 직급이 생긴 경우
this.positionMapping = {
  // ... 기존 매핑들
  '신임교수': '조교수'  // 조교수로 매핑
};

// 또는 새로운 카테고리로
this.positionMapping = {
  // ... 기존 매핑들
  '신임교수': '신임교수'
};
this.fullTimePositions = [
  // ... 기존 직급들
  '신임교수'
];
```

3. **재배포**
   - Git commit & push
   - Render.com 자동 재배포
   - 관리자 페이지에서 엑셀 재업로드

### 문제 4: 조직 순서가 이상함

**원인**: 조직 순서 설정이 잘못되었거나 기본 구조와 맞지 않음

**해결 방법**:
1. 관리자 페이지 > 조직 순서 설정
2. 해당 교원 유형 탭 선택 (전임/비전임/기타)
3. 초기화 버튼 클릭
4. 원하는 순서로 드래그 앤 드롭
5. 저장

### 문제 5: 인쇄가 제대로 안 됨

**체크리스트**:
1. ✅ 용지 크기 설정 확인 (A3/A4)
2. ✅ 방향 설정 확인 (가로/세로)
3. ✅ 브라우저 인쇄 설정에서 "배경 그래픽" 활성화
4. ✅ 데이터가 너무 많은 경우 2페이지로 나뉠 수 있음

---

## 파일 위치 참조

### 백엔드
- **파싱 로직**: `backend/utils/excelParser.js`
- **모델**: `backend/models/Faculty.js`, `backend/models/Organization.js`
- **API 라우트**: `backend/routes/faculty.js`, `backend/routes/organization.js`

### 프론트엔드
- **메인 페이지**: `docs/index.html`
- **관리자 페이지**: `docs/admin.html`
- **스타일**: `docs/css/table-styles.css`, `docs/css/admin.css`
- **API 클라이언트**: `docs/js/api.js`

### 설정
- **프로젝트 설명**: `CLAUDE.md`
- **파싱 가이드**: `PARSING_GUIDE.md` (이 문서)

---

## 자주 묻는 질문 (FAQ)

### Q: 엑셀 파일 형식이 변경되면 어떻게 하나요?
A: `excelParser.js`의 `findColumnIndexes` 함수에서 새로운 컬럼 이름을 추가하세요.

### Q: 새로운 대학이나 학과가 생기면?
A: 자동으로 인식됩니다. 단, 조직 순서를 설정하려면 관리자 페이지에서 수동으로 순서를 지정해야 합니다.

### Q: 시간강사도 표시하고 싶어요
A: `excelParser.js`의 239-242번 줄 주석 처리:
```javascript
// if (rowData.serialType === '시간강사') {
//   continue;
// }
```

### Q: 혁신사업 외에 다른 특별 표시를 추가하려면?
A:
1. `index.html`의 `formatNames` 함수에 조건 추가
2. `table-styles.css`에 새 클래스 스타일 정의
3. 범례에 설명 추가

---

**마지막 업데이트**: 2025-12-23
**작성자**: Claude Code
**버전**: 1.0
